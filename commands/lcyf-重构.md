# /lcyf-重构

## 概述

安全地执行代码重构，保持功能不变的同时优化代码结构。

## 用法

```
/lcyf-重构 <重构目标>
/lcyf-重构 优化UserService结构
/lcyf-重构 提取公共工具方法
/lcyf-重构 消除重复代码
```

## 重构类型

### 1. 方法级重构

| 重构 | 说明 | 示例 |
|------|------|------|
| 提取方法 | 将代码块提取为独立方法 | 长方法拆分 |
| 内联方法 | 将简单方法内联 | 过度封装 |
| 重命名 | 改进命名 | processData→processOrder |
| 移动方法 | 移动到更合适的类 | 职责不清 |

### 2. 类级重构

| 重构 | 说明 | 示例 |
|------|------|------|
| 提取类 | 拆分大类 | 单一职责 |
| 内联类 | 合并小类 | 过度拆分 |
| 提取接口 | 抽象接口 | 依赖倒置 |
| 提取父类 | 消除重复 | 继承复用 |

### 3. 架构级重构

| 重构 | 说明 | 示例 |
|------|------|------|
| 分层重构 | 调整分层 | MVC分离 |
| 模块拆分 | 拆分大模块 | 模块化 |
| 依赖解耦 | 消除耦合 | 接口隔离 |

## 执行流程

```
1. 分析阶段
   └── 理解当前代码结构
   └── 识别代码坏味道

2. 测试准备
   └── 确保测试覆盖率≥80%
   └── 所有测试通过

3. 小步重构
   └── 每次只做一个小改动
   └── 改动后运行测试

4. 验证阶段
   └── 所有测试仍然通过
   └── 功能行为不变
```

## 代码坏味道识别

### 常见坏味道

| 坏味道 | 症状 | 重构方法 |
|--------|------|----------|
| 长方法 | 方法超过50行 | 提取方法 |
| 大类 | 类超过500行 | 提取类 |
| 重复代码 | 相同代码多处出现 | 提取方法/类 |
| 过长参数列表 | 参数超过4个 | 引入参数对象 |
| 发散式变化 | 一个类频繁修改 | 提取类 |
| 霰弹式修改 | 一个改动影响多处 | 移动方法 |
| 依恋情结 | 过多访问其他类 | 移动方法 |
| 数据泥团 | 总是一起出现的数据 | 引入对象 |

## 安全重构原则

### 1. 测试先行

```bash
# 重构前确保测试通过
mvn test

# 检查覆盖率
mvn jacoco:report
# 确保 ≥ 80%
```

### 2. 小步前进

```java
// ❌ 一次性大改
// 重构整个OrderService

// ✅ 小步重构
// 第1步: 提取validateOrder方法
// 第2步: 提取calculatePrice方法
// 第3步: 提取applyDiscount方法
// 每步都运行测试
```

### 3. 保持行为

```java
// 重构前的测试用例
@Test
void processOrder_shouldCalculateCorrectTotal() {
    Order order = createTestOrder();
    orderService.process(order);
    assertThat(order.getTotal()).isEqualTo(100);
}

// 重构后测试必须仍然通过
```

## 输出格式

```markdown
# 重构报告

## 重构目标
优化UserService结构，消除重复代码

## 识别的问题

### 代码坏味道
1. **长方法**: createUser方法120行
2. **重复代码**: 验证逻辑重复3处
3. **过长参数**: updateUser有8个参数

## 重构步骤

### 步骤1: 提取验证方法
- **变更**: 提取validateUserInput方法
- **影响文件**: UserServiceImpl.java
- **测试**: ✅ 通过

### 步骤2: 引入参数对象
- **变更**: 创建UserUpdateCmd替代8个参数
- **影响文件**:
  - UserServiceImpl.java
  - UserController.java
  - UserUpdateCmd.java (新)
- **测试**: ✅ 通过

### 步骤3: 拆分长方法
- **变更**: createUser拆分为5个私有方法
- **影响文件**: UserServiceImpl.java
- **测试**: ✅ 通过

## 重构结果

| 指标 | 重构前 | 重构后 |
|------|--------|--------|
| 最长方法行数 | 120 | 35 |
| 重复代码块 | 3 | 0 |
| 平均方法行数 | 45 | 20 |
| 测试覆盖率 | 82% | 85% |

## 验证结果
✅ 所有测试通过
✅ 功能行为不变
✅ 代码质量提升
```

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| --dry-run | 只分析不执行 | false |
| --scope | 重构范围 | changed |

## 关联命令

- `/lcyf-代码审查` - 代码审查
- `/lcyf-tdd` - 测试驱动开发

## 关联Agent

- 01-规划专家
- 03-Java开发专家
- 07-测试专家

## 关联规则

- 02-编码风格
- 06-Java编码规范
