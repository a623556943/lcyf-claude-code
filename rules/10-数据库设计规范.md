# 10-数据库设计规范

## 概述

数据库设计规范确保数据模型的合理性、性能和可维护性。

## 命名规范

### 表命名

```sql
-- ✅ 使用模块前缀 + 业务名
system_user         -- 系统模块-用户表
system_role         -- 系统模块-角色表
system_user_role    -- 系统模块-用户角色关联表
sales_order         -- 销售模块-订单表
sales_order_item    -- 销售模块-订单项表

-- ❌ 避免
User                -- 无模块前缀
tbl_user            -- 不必要的前缀
t_user              -- 不必要的前缀
userTable           -- 驼峰命名
```

### 字段命名

```sql
-- ✅ 使用小写字母+下划线
id                  -- 主键
user_id             -- 外键
username            -- 用户名
create_time         -- 创建时间
update_time         -- 更新时间

-- ❌ 避免
userId              -- 驼峰命名
CREATE_TIME         -- 全大写
user-name           -- 使用连字符
```

### 索引命名

```sql
-- 主键索引: pk_{表名}
-- 唯一索引: uk_{表名}_{字段}
-- 普通索引: idx_{表名}_{字段}

CREATE UNIQUE INDEX uk_user_username ON system_user(username);
CREATE INDEX idx_user_dept_id ON system_user(dept_id);
CREATE INDEX idx_order_user_status ON sales_order(user_id, status);
```

## 表设计

### 必备字段

```sql
CREATE TABLE system_user (
    -- 主键（必须）
    id BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',

    -- 业务字段
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码',
    nickname VARCHAR(50) COMMENT '昵称',

    -- 审计字段（必须）
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',

    PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

### 字段类型选择

| 数据类型 | MySQL类型 | 说明 |
|----------|-----------|------|
| 主键ID | BIGINT | 自增或雪花算法 |
| 外键ID | BIGINT | 关联其他表 |
| 状态/类型 | TINYINT | 小范围枚举值 |
| 金额 | DECIMAL(18,2) | 精确计算 |
| 短文本 | VARCHAR(n) | 可变长度 |
| 长文本 | TEXT | 大段文字 |
| 日期时间 | DATETIME | 时间戳 |
| 布尔 | BIT(1) | 0/1 |
| JSON | JSON | 结构化数据 |

### 字段长度参考

| 字段类型 | 推荐长度 | 说明 |
|----------|----------|------|
| 用户名 | VARCHAR(50) | |
| 密码（加密后）| VARCHAR(100) | BCrypt |
| 邮箱 | VARCHAR(100) | |
| 手机号 | VARCHAR(20) | 国际号码 |
| URL | VARCHAR(500) | |
| 描述 | VARCHAR(500) | |
| 备注 | VARCHAR(1000) | |

## 索引设计

### 索引原则

```sql
-- ✅ 为常用查询条件添加索引
CREATE INDEX idx_user_username ON system_user(username);
CREATE INDEX idx_user_mobile ON system_user(mobile);

-- ✅ 复合索引遵循最左前缀
CREATE INDEX idx_order_user_status ON sales_order(user_id, status, create_time);
-- 支持: WHERE user_id = ?
-- 支持: WHERE user_id = ? AND status = ?
-- 支持: WHERE user_id = ? AND status = ? AND create_time > ?
-- 不支持: WHERE status = ?（没有user_id）

-- ✅ 覆盖索引优化查询
CREATE INDEX idx_user_status_name ON system_user(status, username);
-- SELECT username FROM user WHERE status = 1; -- 索引覆盖，无需回表
```

### 避免的索引

```sql
-- ❌ 低选择性字段不适合单独建索引
CREATE INDEX idx_user_deleted ON system_user(deleted); -- 只有0/1

-- ❌ 频繁更新的字段谨慎建索引
-- 每次UPDATE都要更新索引

-- ❌ 过多索引影响写入性能
-- 单表索引不宜超过5个
```

## 关联设计

### 一对多关系

```sql
-- 用户表
CREATE TABLE system_user (
    id BIGINT NOT NULL AUTO_INCREMENT,
    dept_id BIGINT COMMENT '部门ID',
    -- ...
    PRIMARY KEY (id),
    KEY idx_user_dept_id (dept_id)
);

-- 部门表
CREATE TABLE system_department (
    id BIGINT NOT NULL AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '部门名称',
    parent_id BIGINT DEFAULT 0 COMMENT '父部门ID',
    -- ...
    PRIMARY KEY (id)
);
```

### 多对多关系

```sql
-- 用户角色关联表
CREATE TABLE system_user_role (
    id BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_role (user_id, role_id),
    KEY idx_role_id (role_id)
) COMMENT='用户角色关联表';
```

## 性能优化

### 分表策略

```sql
-- 按时间分表（大表）
sales_order_202501
sales_order_202502
sales_order_202503

-- 按用户分表
user_data_0
user_data_1
user_data_2
-- hash(user_id) % 3 决定分表
```

### 大字段优化

```sql
-- ✅ 大字段拆分
CREATE TABLE system_user (
    id BIGINT NOT NULL AUTO_INCREMENT,
    username VARCHAR(50),
    -- 基础信息
    PRIMARY KEY (id)
);

CREATE TABLE system_user_ext (
    user_id BIGINT NOT NULL,
    avatar TEXT COMMENT '头像（Base64）',
    resume TEXT COMMENT '简历',
    PRIMARY KEY (user_id)
);
```

## SQL规范

### 查询规范

```sql
-- ✅ 明确指定字段
SELECT id, username, email FROM system_user WHERE id = 1;

-- ❌ 避免 SELECT *
SELECT * FROM system_user WHERE id = 1;

-- ✅ 使用LIMIT限制结果
SELECT * FROM system_user WHERE status = 1 LIMIT 100;

-- ✅ 使用EXISTS代替IN（大数据量）
SELECT * FROM system_user u
WHERE EXISTS (SELECT 1 FROM system_user_role ur WHERE ur.user_id = u.id AND ur.role_id = 1);
```

### 更新规范

```sql
-- ✅ UPDATE必须有WHERE条件
UPDATE system_user SET status = 0 WHERE id = 1;

-- ❌ 禁止无条件UPDATE
UPDATE system_user SET status = 0;

-- ✅ DELETE使用软删除
UPDATE system_user SET deleted = 1 WHERE id = 1;

-- ❌ 避免物理删除
DELETE FROM system_user WHERE id = 1;
```

## 数据迁移

### DDL变更规范

```sql
-- ✅ 添加字段（不锁表）
ALTER TABLE system_user ADD COLUMN nickname VARCHAR(50) COMMENT '昵称';

-- ✅ 添加索引（Online DDL）
ALTER TABLE system_user ADD INDEX idx_nickname (nickname), ALGORITHM=INPLACE, LOCK=NONE;

-- ⚠️ 修改字段类型（可能锁表）
ALTER TABLE system_user MODIFY COLUMN nickname VARCHAR(100);

-- ⚠️ 删除字段（不可逆）
ALTER TABLE system_user DROP COLUMN nickname;
```

## 关联Agent

- 03-Java开发专家.md：数据层开发
- 04-模块协调专家.md：模块间数据关系
