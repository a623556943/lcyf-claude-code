# 11-模块依赖规范

## 概述

模块依赖规范确保模块化单体架构的清晰边界和可维护性。

## 模块结构

### 当前模块清单

| 模块 | 目录 | 职责 |
|------|------|------|
| base | lcyf-module-base | 基础设施、工具类 |
| system | lcyf-module-system | 系统管理、用户权限 |
| sales | lcyf-module-sales | 销售管理 |
| finance | lcyf-module-finance | 财务管理 |
| policy | lcyf-module-policy | 保单管理 |
| product-factory | lcyf-module-product-factory | 产品工厂 |

### 模块内部结构

```
lcyf-module-{name}/
├── src/main/java/com/lcyf/cloud/{name}/
│   ├── adapter/                    # 适配层（入口）
│   │   ├── web/                   # REST API
│   │   ├── rpc/                   # Dubbo RPC
│   │   └── mq/                    # 消息队列消费者
│   ├── biz/                        # 业务层
│   │   ├── service/               # 业务服务接口
│   │   │   └── impl/              # 业务服务实现
│   │   └── infrastructure/        # 基础设施
│   │       ├── entity/            # 数据实体
│   │       └── mapper/            # MyBatis Mapper
│   └── api/                        # API定义层
│       ├── cmd/                   # 命令对象
│       ├── dto/                   # 数据传输对象
│       ├── query/                 # 查询对象
│       └── view/                  # 视图对象
└── src/main/resources/
    └── mapper/                     # MyBatis XML
```

## 依赖规则

### 允许的依赖方向

```
                         ┌─────────┐
                         │  base   │ ← 所有模块都可以依赖
                         └────┬────┘
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
        ┌─────────┐     ┌─────────┐    ┌────────────────┐
        │ system  │     │  sales  │    │ product-factory │
        └────┬────┘     └────┬────┘    └────────────────┘
             │               │
             │               ▼
             │          ┌─────────┐
             └─────────►│ policy  │
                        └────┬────┘
                             │
                             ▼
                        ┌─────────┐
                        │ finance │
                        └─────────┘
```

### 依赖规则表

| 模块 | 可依赖 | 不可依赖 |
|------|--------|----------|
| base | 无 | 所有业务模块 |
| system | base | sales, finance, policy |
| sales | base, system(api) | finance, policy |
| finance | base, system(api), policy(api) | sales |
| policy | base, system(api), sales(api) | finance |
| product-factory | base | 所有业务模块 |

### POM依赖示例

```xml
<!-- lcyf-module-policy/pom.xml -->
<dependencies>
    <!-- ✅ 允许：依赖base模块 -->
    <dependency>
        <groupId>com.lcyf.cloud</groupId>
        <artifactId>lcyf-module-base</artifactId>
    </dependency>

    <!-- ✅ 允许：依赖system的api包 -->
    <dependency>
        <groupId>com.lcyf.cloud</groupId>
        <artifactId>lcyf-module-system-api</artifactId>
    </dependency>

    <!-- ✅ 允许：依赖sales的api包 -->
    <dependency>
        <groupId>com.lcyf.cloud</groupId>
        <artifactId>lcyf-module-sales-api</artifactId>
    </dependency>

    <!-- ❌ 禁止：直接依赖其他模块的biz包 -->
    <!-- <dependency>
        <groupId>com.lcyf.cloud</groupId>
        <artifactId>lcyf-module-sales-biz</artifactId>
    </dependency> -->
</dependencies>
```

## 跨模块通信

### 方式1: RPC调用（推荐）

```java
// sales模块定义API接口
// lcyf-module-sales-api
public interface UserApi {
    @DubboService
    UserDTO getUserById(Long id);
}

// system模块实现API
// lcyf-module-system-biz
@DubboService
public class UserApiImpl implements UserApi {
    @Resource
    private IUserService userService;

    @Override
    public UserDTO getUserById(Long id) {
        return userService.getById(id);
    }
}

// policy模块调用
// lcyf-module-policy-biz
@Service
public class PolicyServiceImpl {
    @DubboReference
    private UserApi userApi;

    public void process(Long userId) {
        UserDTO user = userApi.getUserById(userId);
        // 使用user信息
    }
}
```

### 方式2: 事件驱动

```java
// sales模块发布事件
@Service
public class OrderServiceImpl {
    @Resource
    private ApplicationEventPublisher eventPublisher;

    public void createOrder(OrderCreateCmd cmd) {
        // 创建订单
        Order order = createOrderInternal(cmd);

        // 发布事件
        eventPublisher.publishEvent(new OrderCreatedEvent(order.getId(), order.getUserId()));
    }
}

// finance模块监听事件
@Component
public class OrderEventListener {

    @EventListener
    @Async
    public void onOrderCreated(OrderCreatedEvent event) {
        // 处理订单创建后的财务逻辑
        createFinanceRecord(event.getOrderId());
    }
}
```

### 方式3: 消息队列

```java
// sales模块发送消息
@Service
public class OrderServiceImpl {
    @Resource
    private RocketMQTemplate rocketMQTemplate;

    public void createOrder(OrderCreateCmd cmd) {
        Order order = createOrderInternal(cmd);

        // 发送消息
        rocketMQTemplate.convertAndSend("order-topic",
            new OrderMessage(order.getId(), order.getUserId()));
    }
}

// finance模块消费消息
@Component
@RocketMQMessageListener(topic = "order-topic", consumerGroup = "finance-consumer")
public class OrderMessageConsumer implements RocketMQListener<OrderMessage> {

    @Override
    public void onMessage(OrderMessage message) {
        // 处理消息
        processOrder(message);
    }
}
```

## 禁止的依赖

### 循环依赖

```
❌ A → B → C → A（禁止）

模块A
    ↓
模块B
    ↓
模块C
    ↓
模块A（形成循环）
```

### 跨层调用

```java
// ❌ Controller直接调用Mapper
@RestController
public class UserController {
    @Resource
    private UserMapper userMapper; // 禁止！

    @GetMapping("/user/{id}")
    public User get(@PathVariable Long id) {
        return userMapper.selectById(id);
    }
}

// ✅ 正确：通过Service调用
@RestController
public class UserController {
    @Resource
    private IUserService userService;

    @GetMapping("/user/{id}")
    public User get(@PathVariable Long id) {
        return userService.getById(id);
    }
}
```

### 直接依赖实现类

```java
// ❌ 禁止：依赖其他模块的ServiceImpl
import com.lcyf.cloud.system.biz.service.impl.UserServiceImpl;

// ✅ 正确：通过API接口调用
import com.lcyf.cloud.system.api.UserApi;
```

## 依赖检查

### Maven检查命令

```bash
# 检查依赖树
mvn dependency:tree -Dincludes=com.lcyf.cloud

# 分析依赖问题
mvn dependency:analyze

# 检查循环依赖
mvn org.apache.maven.plugins:maven-dependency-plugin:analyze-dep-mgt
```

### 代码检查

```java
// 检查import语句是否违规
// ✅ 正确
import com.lcyf.cloud.base.util.DateUtils;
import com.lcyf.cloud.system.api.UserApi;

// ❌ 违规
import com.lcyf.cloud.system.biz.service.impl.UserServiceImpl;
import com.lcyf.cloud.sales.biz.infrastructure.mapper.OrderMapper;
```

## 新增模块流程

1. 确定模块职责和边界
2. 确定与现有模块的依赖关系
3. 创建模块目录结构
4. 定义API包（供其他模块调用）
5. 实现业务逻辑
6. 更新模块依赖图

## 关联Agent

- 04-模块协调专家.md：模块依赖分析
- 02-架构专家.md：架构设计
