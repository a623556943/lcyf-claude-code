# 01-安全规范

## 概述

安全是最高优先级，所有代码必须遵循安全编码规范。

## 敏感信息处理

### 禁止硬编码

```java
// ❌ 禁止
private static final String API_KEY = "sk-proj-xxxxx";
private static final String DB_PASSWORD = "123456";

// ✅ 正确
@Value("${api.key}")
private String apiKey;

@Value("${spring.datasource.password}")
private String dbPassword;
```

### 配置文件安全

```yaml
# ❌ 禁止：生产环境明文密码
spring:
  datasource:
    password: mypassword123

# ✅ 正确：使用环境变量或加密
spring:
  datasource:
    password: ${DB_PASSWORD}
    # 或使用jasypt加密
    password: ENC(加密后的密码)
```

## 输入验证

### 参数校验

```java
// ✅ 使用JSR-380验证
@PostMapping("/user")
public Result create(@Valid @RequestBody UserDTO dto) {
    // dto已经过验证
}

// DTO中的验证注解
public class UserDTO {
    @NotBlank(message = "用户名不能为空")
    @Size(min = 2, max = 50, message = "用户名长度2-50")
    private String username;

    @Email(message = "邮箱格式不正确")
    private String email;

    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;
}
```

### 防止注入攻击

```java
// ❌ SQL注入风险
@Select("SELECT * FROM user WHERE name = '" + name + "'")
User findByName(String name);

// ✅ 参数化查询
@Select("SELECT * FROM user WHERE name = #{name}")
User findByName(@Param("name") String name);

// ❌ XSS风险
return "<div>" + userInput + "</div>";

// ✅ HTML转义
return "<div>" + HtmlUtils.htmlEscape(userInput) + "</div>";
```

## 认证与授权

### 权限控制

```java
// ✅ 方法级权限控制
@PreAuthorize("@ss.hasPermission('system:user:create')")
@PostMapping("/user")
public Result createUser(@RequestBody UserDTO dto) {
    // ...
}

// ✅ 数据级权限控制
@DataPermission
@GetMapping("/user/list")
public Result listUsers() {
    // 自动过滤用户只能看到的数据
}
```

### 密码处理

```java
// ✅ 使用BCrypt加密
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}

// 存储密码
user.setPassword(passwordEncoder.encode(rawPassword));

// 验证密码
boolean matches = passwordEncoder.matches(rawPassword, encodedPassword);
```

## 日志安全

### 脱敏处理

```java
// ❌ 禁止记录敏感信息
log.info("用户登录: username={}, password={}", username, password);
log.info("支付请求: cardNumber={}", cardNumber);

// ✅ 脱敏或不记录
log.info("用户登录: username={}", username);
log.info("支付请求: cardNumber={}", mask(cardNumber));

private String mask(String cardNumber) {
    if (cardNumber == null || cardNumber.length() < 8) {
        return "****";
    }
    return cardNumber.substring(0, 4) + "****" +
           cardNumber.substring(cardNumber.length() - 4);
}
```

## 文件操作

### 路径穿越防护

```java
// ❌ 路径穿越风险
String filename = request.getParameter("file");
File file = new File("/uploads/" + filename);
// 攻击者可以传入 "../../../etc/passwd"

// ✅ 验证文件路径
String filename = request.getParameter("file");
String safeFilename = FilenameUtils.getName(filename); // 移除路径
File file = new File("/uploads/" + safeFilename);

// 或者验证规范化路径
Path path = Paths.get("/uploads", filename).normalize();
if (!path.startsWith("/uploads")) {
    throw new SecurityException("非法路径");
}
```

## 加密要求

| 场景 | 算法 | 说明 |
|------|------|------|
| 密码存储 | BCrypt | 自带盐值 |
| 数据加密 | AES-256 | 对称加密 |
| 签名验证 | SHA-256 | 摘要算法 |
| 传输加密 | TLS 1.2+ | HTTPS |

## 安全检查清单

### 提交前检查

- [ ] 无硬编码密钥/密码
- [ ] 所有输入已验证
- [ ] SQL使用参数化查询
- [ ] 权限控制已配置
- [ ] 日志无敏感信息
- [ ] 文件操作已验证路径

### 定期检查

- [ ] 依赖库无已知漏洞
- [ ] 安全配置已启用
- [ ] 密钥定期轮换
- [ ] 访问日志已审计

## 关联Agent

- 06-安全审查专家.md：安全漏洞检测和修复
