# 知识库存储架构

## 概述

lcyf-claude-code v2.0 的知识库采用分层存储架构，将不同类型的知识分类存储，便于管理和检索。

## 目录结构

```
项目根目录/
├── build-parent/doc/               # 项目级知识库（Git追踪）
│   └── knowledge/                  # 知识库根目录
│       ├── learned-patterns/       # 自动学习的模式
│       │   ├── 2025-01-26-异常处理模式.md
│       │   ├── 2025-01-26-缓存使用模式.md
│       │   └── 2025-01-25-SQL优化模式.md
│       │
│       ├── team-conventions/       # 团队约定
│       │   ├── 命名规范.md
│       │   ├── 代码审查清单.md
│       │   └── 接口设计约定.md
│       │
│       ├── instincts/              # 本能库（高频模式）
│       │   ├── common-mistakes.json   # 常见错误模式
│       │   ├── best-practices.json    # 最佳实践模式
│       │   └── quick-fixes.json       # 快速修复模式
│       │
│       ├── checkpoints.log         # 检查点日志
│       ├── session-history/        # 会话历史
│       │   ├── 2025-01-26-session-001.json
│       │   └── 2025-01-26-session-002.json
│       │
│       └── module-knowledge/       # 模块特定知识
│           ├── sales/
│           │   ├── 业务规则.md
│           │   └── 常见问题.md
│           ├── finance/
│           ├── policy/
│           └── system/
│
└── ~/.claude/                      # 全局知识库（用户级）
    ├── lcyf-knowledge/            # lcyf专属全局知识
    │   ├── java-patterns/         # Java通用模式
    │   ├── spring-boot-tips/      # Spring Boot技巧
    │   └── mybatis-snippets/      # MyBatis代码片段
    │
    └── global-instincts/          # 跨项目本能
        └── code-quality.json
```

## 知识类型

### 1. 自动学习模式 (learned-patterns/)

**来源**: 从开发会话中自动提取

**格式**: Markdown

**示例**:
```markdown
# 异常处理模式

## 模式识别时间
2025-01-26 10:30

## 使用频率
高频 (8次/最近10次会话)

## 模式描述
在Service层捕获异常并转换为业务异常

## 代码模式
\```java
try {
    // 业务逻辑
} catch (Exception e) {
    log.error("操作失败: {}", e.getMessage(), e);
    throw new BusinessException(ErrorCode.OPERATION_FAILED, "具体错误信息");
}
\```

## 适用场景
- 数据库操作
- 外部API调用
- 文件操作

## 注意事项
- 不要吞掉异常
- 记录完整堆栈
- 转换为业务异常
```

### 2. 团队约定 (team-conventions/)

**来源**: 团队手动编写或审查确认

**格式**: Markdown

**示例**:
```markdown
# 命名规范

## Controller命名
- 格式: {业务}Controller
- 示例: UserController, OrderController

## Service命名
- 接口: I{业务}Service
- 实现: {业务}ServiceImpl
- 示例: IUserService, UserServiceImpl

## Mapper命名
- 接口: {业务}Mapper
- XML: {业务}Mapper.xml
- 示例: UserMapper, UserMapper.xml
```

### 3. 本能库 (instincts/)

**来源**: 高频模式自动升级为本能

**格式**: JSON

**示例 - common-mistakes.json**:
```json
{
  "mistakes": [
    {
      "id": "hardcoded-password",
      "pattern": "password\\s*=\\s*[\"']",
      "severity": "critical",
      "message": "检测到硬编码密码",
      "suggestion": "使用配置文件或环境变量",
      "frequency": 15,
      "lastSeen": "2025-01-26"
    },
    {
      "id": "sql-concat",
      "pattern": "String.*sql.*=.*\\+",
      "severity": "high",
      "message": "检测到SQL拼接",
      "suggestion": "使用MyBatis参数化查询",
      "frequency": 12,
      "lastSeen": "2025-01-25"
    }
  ]
}
```

**示例 - best-practices.json**:
```json
{
  "practices": [
    {
      "id": "service-transaction",
      "trigger": "创建Service方法 且 涉及数据库修改",
      "action": "添加@Transactional注解",
      "confidence": 0.95,
      "frequency": 45
    },
    {
      "id": "controller-validation",
      "trigger": "创建Controller方法 且 有RequestBody参数",
      "action": "添加@Valid注解",
      "confidence": 0.98,
      "frequency": 52
    }
  ]
}
```

### 4. 会话历史 (session-history/)

**来源**: 每个开发会话自动保存

**格式**: JSON

**示例**:
```json
{
  "sessionId": "2025-01-26-session-001",
  "startTime": "2025-01-26T10:00:00Z",
  "endTime": "2025-01-26T12:30:00Z",
  "duration": 9000,
  "summary": "实现用户登录功能",
  "commands": [
    "/lcyf-新功能",
    "/lcyf-tdd",
    "/lcyf-代码审查"
  ],
  "filesModified": [
    "UserController.java",
    "UserService.java",
    "UserMapper.java"
  ],
  "extractedPatterns": [
    "JWT-token-generation",
    "password-encryption",
    "login-logging"
  ],
  "issuesFound": 2,
  "issuesFixed": 2,
  "testsAdded": 5,
  "coverageChange": "+8%"
}
```

### 5. 模块知识 (module-knowledge/)

**来源**: 团队手动编写

**格式**: Markdown

**示例 - sales/业务规则.md**:
```markdown
# Sales模块业务规则

## 协议管理

### 协议状态流转
草稿 → 待审核 → 已生效 → 已失效

### 协议版本规则
- 同一协议可有多个版本
- 只能有一个生效版本
- 作废后不可恢复

## 佣金结算

### 结算周期
- 首期: T+30
- 续期: T+60
```

## 知识检索

### 1. 相似度搜索

```javascript
// 搜索相似模式
const patterns = await knowledge.search({
  query: "异常处理",
  type: "learned-patterns",
  limit: 5
});
```

### 2. 关键词索引

```json
{
  "索引": {
    "异常处理": ["learned-patterns/异常处理模式.md"],
    "缓存": ["learned-patterns/缓存使用模式.md"],
    "SQL优化": ["learned-patterns/SQL优化模式.md"]
  }
}
```

### 3. 频率排序

高频模式优先推荐

## 知识更新流程

```
开发会话
  ↓
自动提取模式
  ↓
存储到 learned-patterns/
  ↓
计算频率
  ↓
频率 > 阈值？
  ↓ 是
升级为本能 (instincts/)
  ↓
实时应用于新会话
```

## 知识同步

### 团队协作

```bash
# 提交项目知识库
git add build-parent/doc/knowledge/
git commit -m "chore: update learned patterns"
git push

# 其他成员拉取
git pull
```

### 个人知识保护

`.gitignore` 配置:
```
# 个人会话历史不共享
build-parent/doc/knowledge/session-history/

# 团队知识共享
!build-parent/doc/knowledge/learned-patterns/
!build-parent/doc/knowledge/team-conventions/
!build-parent/doc/knowledge/module-knowledge/
```

## 知识清理

### 自动清理策略

```javascript
{
  "retention": {
    "session-history": "30天",
    "learned-patterns": "保留使用频率>3的模式",
    "instincts": "永久保留"
  }
}
```

### 手动清理

```bash
lcyf knowledge clean --older-than 30d
```

## 与其他系统集成

### CI/CD集成

在CI流程中使用团队知识：
```yaml
- name: Apply team standards
  run: lcyf knowledge apply-conventions
```

### IDE集成

未来支持IDE插件实时提示

## 注意事项

- **隐私保护**: 不要在知识库中存储敏感信息
- **定期审查**: 定期审查learned-patterns，确认是否应该成为team-conventions
- **版本控制**: 重要的team-conventions应该版本化
- **文档同步**: 知识库应与项目文档保持同步
